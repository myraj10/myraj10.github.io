<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no"/>
  <meta name="theme-color" content="#ADD8E6">
  <title>Visual Scheduler</title>
  <!-- PWA Manifest Link -->
  <link rel="manifest" href="manifest.json">
  <style>
    :root {
      --bg: #1f1f23;
      --card: #6699ff;
      --muted: #2a2a2f;
      --text: #fff;
      --primary-action: #2e7d32;
      --danger-action: #8b2d2d;
    }
    * {
      box-sizing: border-box;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
    }
    body {
      margin: 0;
      background: var(--bg);
      color: var(--text);
      display: flex;
      flex-direction: column;
      height: 100vh;
      overflow: hidden; /* Prevent body scroll */
    }
    header, footer {
      display: flex;
      align-items: center;
      gap: .5rem;
      padding: .75rem;
      background: var(--muted);
      position: sticky;
      flex-shrink: 0;
      z-index: 10;
    }
    header { top: 0;
      /* This pushes the content down away from the status bar */
      padding-top: env(safe-area-inset-top, 30px); 
      /* This makes the bar tall enough so the buttons don't look cramped */
      min-height: 90px; }

    footer { bottom: 0; }
    h1 {
      flex: 1;
      text-align: center;
      margin: 0;
      font-size: 1.1rem;
    }
    button {
      background: #3a3a44;
      color: #fff;
      border: none;
      border-radius: 12px;
      padding: .5rem .7rem;
      cursor: pointer;
      font-size: 1.2rem;
      -webkit-tap-highlight-color: transparent; /* Disable tap highlight on mobile */
    }
    main {
      padding: .75rem;
      flex: 1;
      overflow-y: auto; /* Allow only main content to scroll */
    }
    header button, footer button {
      color: #000;
      background-color: #fff;
    }
    header button:hover, footer button:hover {
      background-color: #e0e0e0;
    }
    ul.tasks {
      list-style: none;
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      gap: .6rem;
    }
    .task {
      display: flex;
      align-items: center;
      gap: .6rem;
      background: var(--card);
      border-radius: 14px;
      padding: .5rem;
      transition: transform .15s ease, opacity .15s ease;
      -webkit-tap-highlight-color: transparent;
    }
    .task .thumb {
      width: 44px;
      height: 44px;
      border-radius: 12px;
      background: #0003;
      object-fit: cover;
      flex-shrink: 0;
    }
    .task .meta {
      flex: 1;
      overflow: hidden; /* Prevent text from overflowing */
    }
    .task .name {
      font-weight: 700;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .task .time {
      opacity: .9;
      font-size: .85rem;
    }
    .task.doneItem {
      opacity: .6;
    }
    .task.doneItem .name, .task.doneItem .time {
        text-decoration: line-through;
    }
    .progress-wrap {
      flex: 1;
      height: 16px;
      background: #0004;
      border-radius: 20px;
      overflow: hidden;
    }
    .progress {
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, #a88bff, #6dd5ed);
    }
    dialog {
      border: none;
      border-radius: 16px;
      padding: 1.2rem;
      max-width: 480px;
      width: 90vw;
      background: var(--muted);
      color: var(--text);
    }
    dialog::backdrop {
      background: #00000088;
    }
    dialog menu {
      display: flex;
      justify-content: flex-end;
      gap: .5rem;
      margin: 0;
      padding-top: 1rem;
    }
    dialog label {
      display: block;
      margin-bottom: 0.8rem;
    }
    dialog input[type="text"], dialog input[type="time"], dialog input[type="date"], dialog input[type="number"], dialog input[type="file"] {
      width: 100%;
      padding: 8px;
      border-radius: 8px;
      border: 1px solid #555;
      background: #333;
      color: #fff;
      margin-top: 4px;
    }
    .inline-row {
      display: flex;
      align-items: center;
      gap: .5rem;
      margin: .25rem 0;
    }
    button.danger { background: var(--danger-action); }
    button.primary { background: var(--primary-action); }
    .days-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: .3rem;
      margin: .5rem 0;
    }
    .setup-actions { margin: .3rem 0; }
    hr {
      border: none;
      border-top: 1px solid #555;
      margin: .5rem 0;
    }
    #confettiCanvas {
      position: fixed;
      inset: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 20;
    }
    #viewerDialog {
      padding: 0;
      max-width: min(92vw, 520px);
      width: 92%;
    }
    #viewerDialog .viewer {
      display: flex;
      flex-direction: column;
    }
    #viewerDialog img {
      width: 100%;
      height: auto;
      display: block;
      border-radius: 16px 16px 0 0;
      object-fit: contain;
      background: #111;
      max-height: 70vh;
    }
    #viewerDialog menu { padding: .75rem; }

    /* --- Drag and Reorder Styles --- */
    .task .drag-handle {
      display: none; /* Hidden by default */
      padding: 0 10px;
      cursor: grab;
      font-size: 1.6rem;
      align-self: stretch;
      align-items: center;
      touch-action: none; /* Prevents scrolling on touch devices */
      -webkit-tap-highlight-color: transparent;
    }
    .reordering .task .drag-handle {
      display: flex; /* Visible only in reordering mode */
    }
    /* In reorder mode, hide action buttons for a cleaner interface */
    .reordering .task .edit,
    .reordering .task .delete,
    .reordering .task .done {
      display: none;
    }
    /* Style for the item being dragged */
    .sortable-ghost {
      opacity: 0.4;
      background: #4a6d9e;
    }
    .sortable-drag {
      opacity: 0.9;
      transform: scale(1.05);
      box-shadow: 0 5px 15px #0000004d;
    }

    /* --- UPDATED: Modern Transparent Icon Styles --- */
    .task .edit, .task .delete, .task .done {
      background: none;
      border: none;
      padding: 0.5rem;
      margin: 0;
      cursor: pointer;
      transition: transform 0.2s ease;
      filter: drop-shadow(0 1px 2px rgba(0,0,0,0.5));
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .task .edit:hover, .task .delete:hover, .task .done:hover {
      transform: scale(1.15);
    }
    .task .icon-svg {
        width: 24px;
        height: 24px;
    }
    .task .edit .icon-svg {
      fill: #ffffff;
    }
    .task .delete .icon-svg {
      fill: #ff6b6b;
    }
    .task .done .icon-svg {
      fill: #51cf66;
      stroke: #51cf66;       /* Add this line */
      stroke-width: 1.5;     /* Add this line */
}
  </style>
</head>
<body>
  <header>
    <button id="backDay" aria-label="Previous day">◀</button>
    <h1 id="dayName">Loading...</h1>
    <button id="editDayName" title="Edit day name">✎</button>
    <button id="forwardDay" aria-label="Next day">▶</button>
    <button id="reorderToggle" title="Reorder list">↕</button>
  </header>

  <main>
    <ul id="taskList" class="tasks"></ul>
  </main>

  <footer>
    <button id="resetDay" title="Reset progress">⟲</button>
    <div class="progress-wrap"><div id="progressBar" class="progress"></div></div>
    <button id="addTask" title="Add new task">＋</button>
    <button id="settingsBtn" title="Settings">⚙️</button>
  </footer>

  <!-- UPDATED Task item template with SVG icons -->
  <template id="taskItemTpl">
    <li class="task">
      <span class="drag-handle">☰</span>
      <img class="thumb" alt="icon"/>
      <div class="meta">
        <div class="name"></div>
        <div class="time"></div>
      </div>
      <button class="edit" title="Edit">
        <svg class="icon-svg" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><circle cx="12" cy="12" r="2"/><circle cx="19" cy="12" r="2"/><circle cx="5" cy="12" r="2"/></svg>
      </button>
      <button class="delete" title="Delete">
        <svg class="icon-svg" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg>
      </button>
      <button class="done" title="Done">
        <svg class="icon-svg" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>
      </button>
    </li>
  </template>

  <!-- Dialogs -->
  <dialog id="viewerDialog">
    <div class="viewer">
      <img id="viewerImg" alt="Activity" />
      <menu>
        <button type="button" id="viewerClose">Close</button>
        <button type="button" id="viewerFinish" class="primary">Finished</button>
      </menu>
    </div>
  </dialog>

  <dialog id="editDialog">
    <form id="editForm" onsubmit="return false;">
      <h3>Edit Task</h3>
      <label>Name <input type="text" id="taskName"/></label>
      <label>Time <input type="time" id="taskTime"/></label>
      <label>Image <input type="file" id="taskImage" accept="image/*"/></label>
      <div class="inline-row">
        <img id="imagePreview" style="max-width:80px;max-height:80px;border-radius:8px;display:none;border:1px solid #999;margin-top:.3rem" alt="preview"/>
        <button type="button" id="resetImageBtn">Reset to default</button>
      </div>
      <label>Voice (optional) <input type="file" id="taskAudio" accept="audio/*"/></label>
      <div class="inline-row"><button type="button" id="removeVoiceBtn">Remove voice</button></div>
      <label><input type="checkbox" id="taskOneTime"/> One-time event</label>
      <label id="oneTimeDateWrap" style="display:none;">Date <input type="date" id="taskDate"/></label>
      <label>Timer minutes <input type="number" id="taskTimer" min="1" max="180"/></label>
      <menu>
        <button type="button" id="cancelTaskBtn">Cancel</button>
        <button type="button" id="saveTaskBtn" class="primary">Save</button>
      </menu>
    </form>
  </dialog>

  <dialog id="setupDialog">
    <div class="setup">
      <h3>Day & Week Settings</h3>
      <section class="setup-actions">
        <button id="restoreDefaultsDay">Restore defaults for this day</button>
        <button id="clearThisDay" class="danger">Clear this day</button>
      </section>
      <hr/>
      <section>
        <p><b>Copy THIS day's list to other days:</b></p>
        <div class="days-grid">
          <label><input type="checkbox" class="copyDay" value="0"> Monday</label>
          <label><input type="checkbox" class="copyDay" value="1"> Tuesday</label>
          <label><input type="checkbox" class="copyDay" value="2"> Wednesday</label>
          <label><input type="checkbox" class="copyDay" value="3"> Thursday</label>
          <label><input type="checkbox" class="copyDay" value="4"> Friday</label>
          <label><input type="checkbox" class="copyDay" value="5"> Saturday</label>
          <label><input type="checkbox" class="copyDay" value="6"> Sunday</label>
        </div>
        <div class="setup-actions"><button id="copyToSelected" class="primary">Copy to selected days</button></div>
      </section>
      <hr/>
      <section class="setup-actions"><button id="resetWeekDefaults" class="danger">Reset whole week to defaults</button></section>
      <menu><button type="button" id="setupClose">Close</button></menu>
    </div>
  </dialog>

  <dialog id="confirmDialog">
    <div class="confirm">
      <p id="confirmText">Confirm?</p>
      <menu>
        <button type="button" id="confirmCancel">Cancel</button>
        <button type="button" id="confirmOk" class="danger">Confirm</button>
      </menu>
    </div>
  </dialog>

  <canvas id="confettiCanvas"></canvas>
  <audio id="applause" src="assets/sounds/applause.mp3" preload="auto"></audio>

  <!-- Third-party library for drag-and-drop -->
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>

  <script>
    // PWA Service Worker Registration
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('service-worker.js').then(registration => {
          console.log('ServiceWorker registration successful with scope: ', registration.scope);
        }, err => {
          console.log('ServiceWorker registration failed: ', err);
        });
      });
    }

    (function () {
      // --- UTILITY FUNCTIONS ---
      function $(s, el){ return (el||document).querySelector(s); }
      function $all(s, el){ return Array.prototype.slice.call((el||document).querySelectorAll(s)); }

      // --- APP STATE AND DATA ---
      const STORAGE_KEY = 'vsched-data-simplified-v5';
      const dayNames = ['Monday','Tuesday','Wednesday','Thursday','Friday','Saturday','Sunday'];
      let data = null;
      let currentDayIndex = (new Date().getDay() + 6) % 7; // Monday is 0
      let pendingReorder = null;

      // --- DEFAULT DATA ---
      const defaultTasksOrder = [
          "Wake up","Dress up","Wash hands","Comb hair","Bus ride","Drawing","Ride bicycle", "Breakfast","Shower","Brush teeth","School","Lunch","Sports","Go home","Parent pick up", "Clean room","Homework","Play games","Go to sleep","Walk with a dog", "Art and Craft","Dance","Garden","Group Game","Music","Skating","Swimming", "Table Top Activities","Yoga"
      ];

      const defaultTimes = [
        "07:00 AM","07:05 AM","07:10 AM","07:12 AM","07:30 AM","07:31 AM","07:32 AM","07:35 AM","07:40 AM","07:45 AM","08:00 AM","10:00 AM","10:10 AM","10:20 AM","10:30 AM","10:40 AM","10:50 AM","11:00 AM","11:10 AM","11:20 AM","12:00 PM","04:00 PM","05:30 PM","05:35 PM","06:00 PM","07:00 PM","08:00 PM","09:30 PM","06:30 PM"
            ];
      
      function norm(name){ return String(name||'').toLowerCase().replace(/[^a-z0-9]+/g,'_'); }
      function mkId(name){ return name.toLowerCase().replace(/[^a-z0-9]+/g,'_'); }
      function pickImg(name){ return 'assets/images/defaults/'+norm(name||'')+'.png'; }

      function generateDefaultData() {
        const defaultDayTasks = defaultTasksOrder.map((name, i) => ({
          id: mkId(name), name: name, time: defaultTimes[i]||'', image: pickImg(name),
          audio: null, timer_minutes: null, one_time: false, completed: false
        }));
        const defaultData = { version: 1, days: {} };
        dayNames.forEach(name => {
          defaultData.days[name] = { name: name, tasks: JSON.parse(JSON.stringify(defaultDayTasks)) };
        });
        return defaultData;
      }
      const DEFAULT_DATA = generateDefaultData();

      // --- DATA MANAGEMENT ---
      function loadData(){
        try {
          const s = localStorage.getItem(STORAGE_KEY);
          data = s ? JSON.parse(s) : JSON.parse(JSON.stringify(DEFAULT_DATA));
        } catch(e){
          console.error("Failed to load data, using defaults.", e);
          data = JSON.parse(JSON.stringify(DEFAULT_DATA));
        }
        saveData();
        render();
      }
      function saveData(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(data)); }
      function getDay(){ return data.days[dayNames[currentDayIndex]]; }

      // --- RENDERING ---
      function render(){
        const d = getDay();
        const dayEl = $('#dayName'); if (!dayEl) return;
        dayEl.textContent = d.name;

        const list = $('#taskList'); if (!list) return;
        list.innerHTML = '';
        let done = 0;

        d.tasks.forEach((t, i) => {
          const tpl = $('#taskItemTpl');
          if (!tpl || !tpl.content) return;
          const li = tpl.content.firstElementChild.cloneNode(true);
          li.setAttribute('data-index', i);

          $('.thumb', li).src = (t.image || pickImg(t.name));
          $('.thumb', li).onerror = e => { e.target.onerror=null; e.target.src='assets/images/defaults/default.png'; };
          $('.name', li).textContent = t.name || 'Task';
          $('.time', li).textContent = t.time || '';

          $('.edit', li).onclick = () => openEdit(i);
          $('.delete', li).onclick = () => delTask(i);
          $('.done', li).onclick = () => toggleDone(i);
          $('.thumb', li).onclick = () => openViewer(i);
          $('.meta', li).onclick = () => openViewer(i);

          if (t.completed){ li.classList.add('doneItem'); done++; }
          list.appendChild(li);
        });

        const bar = $('#progressBar');
        if (bar) {
          const pct = d.tasks.length ? Math.round(100*done/d.tasks.length) : 0;
          bar.style.width = pct + '%';
        }
        wireDragDrop();
      }

      // --- DRAG AND DROP ---
      function wireDragDrop() {
        const list = $("#taskList");
        if (!list) return;
        if (list._sortable) list._sortable.destroy();

        list._sortable = Sortable.create(list, {
          animation: 200,
          handle: '.drag-handle',
          draggable: '.task',
          forceFallback: true, // Essential for consistent mobile behavior
          onEnd: () => {
            pendingReorder = Array.from(list.children).map(el => parseInt(el.dataset.index));
          }
        });
      }

      // --- ACTIONS (EDIT, DELETE, DONE) ---
      function openEdit(i) { /* ... implementation ... */ }
      function delTask(i) {
        confirmInApp('Are you sure you want to delete this task?').then(ok => {
          if (!ok) return;
          getDay().tasks.splice(i, 1);
          saveData();
          render();
        });
      }
      function toggleDone(i){
        const t = getDay().tasks[i];
        if (!t) return;
        t.completed = !t.completed;
        if (t.completed){
          try {
            const a = $('#applause');
            if (a) { a.currentTime = 0; a.play(); }
          } catch(e){}
          const li = $(`#taskList .task[data-index="${i}"]`);
          if (li) celebrateAtElement(li);
          if (t.audio){ try { new Audio(t.audio).play(); } catch(e){} }
        }
        saveData();
        render();
      }

      // --- DIALOGS & CONFETTI ---
      function openDialog(dlg){
        try { if (dlg.showModal) dlg.showModal(); else dlg.setAttribute('open',''); }
        catch(e){ dlg.setAttribute('open',''); }
      }
      function safeClose(dlg){
        try { dlg.close(); } catch(e){}
        dlg.removeAttribute('open');
      }
      function confirmInApp(message) { /* ... implementation ... */ }
      function alertInApp(message) { /* ... implementation ... */ }
      function celebrateAtElement(el) { /* ... implementation ... */ }
      // (Implementations for dialogs and confetti are omitted for brevity but are the same as your original file)

      // --- GLOBAL EVENT LISTENERS ---
      function installGlobal(){
        $('#backDay').onclick = () => { currentDayIndex = (currentDayIndex + 6) % 7; render(); };
        $('#forwardDay').onclick = () => { currentDayIndex = (currentDayIndex + 1) % 7; render(); };
        $('#editDayName').onclick = () => {
          const d = getDay();
          const n = prompt('Rename this day/list:', d.name);
          if (n) { d.name = n.trim(); saveData(); render(); }
        };
        $('#resetDay').onclick = () => {
          getDay().tasks.forEach(t => t.completed = false);
          saveData();
          render();
        };
        $('#addTask').onclick = () => {
          getDay().tasks.push({ id:'new_'+Date.now(), name:'New task', time:'', image: pickImg('New task'), completed:false });
          saveData();
          render();
          $('#taskList').scrollTop = $('#taskList').scrollHeight;
        };
        $('#settingsBtn').onclick = () => {
          $all('.copyDay').forEach(box => box.checked = false);
          openDialog($('#setupDialog'));
        };
        $('#setupClose').onclick = () => safeClose($('#setupDialog'));
        
        // --- Reorder Toggle Logic (MOVED HERE TO FIX SCOPE) ---
        $('#reorderToggle').addEventListener("click", () => {
          const isReordering = document.body.classList.toggle("reordering");
          $('#reorderToggle').textContent = isReordering ? "✓" : "↕";
          $('#reorderToggle').title = isReordering ? "Done Reordering" : "Reorder list";

          if (!isReordering && pendingReorder) {
            const d = getDay();
            const newTasks = pendingReorder.map(index => d.tasks[index]);
            d.tasks = newTasks;
            saveData();
            pendingReorder = null;
            render();
          }
        });
        
        // --- SETTINGS DIALOG LOGIC ---
        $('#clearThisDay').onclick = () => {
            confirmInApp('Clear all tasks for this day?').then(ok => {
                if (!ok) return;
                getDay().tasks = [];
                saveData(); render(); safeClose($('#setupDialog'));
            });
        };
        $('#restoreDefaultsDay').onclick = () => {
            const name = dayNames[currentDayIndex];
            const def = DEFAULT_DATA.days[name];
            confirmInApp(`Restore defaults for ${name}?`).then(ok => {
                if (!ok) return;
                data.days[name].tasks = JSON.parse(JSON.stringify(def.tasks));
                saveData(); render(); safeClose($('#setupDialog'));
            });
        };
        $('#resetWeekDefaults').onclick = () => {
            confirmInApp('Reset ALL days to defaults?').then(ok => {
                if (!ok) return;
                dayNames.forEach(nm => {
                    data.days[nm].tasks = JSON.parse(JSON.stringify(DEFAULT_DATA.days[nm].tasks));
                });
                saveData(); render(); safeClose($('#setupDialog'));
            });
        };
        $('#copyToSelected').onclick = () => {
            const from = getDay();
            const selectedIndices = $all('.copyDay:checked').map(box => parseInt(box.value, 10));

            if (!selectedIndices.length) { alertInApp('Select at least one day to copy to.'); return; }

            selectedIndices.forEach(idx => {
                const targetDayName = dayNames[idx];
                const clonedTasks = JSON.parse(JSON.stringify(from.tasks));
                clonedTasks.forEach(t => t.completed = false);
                data.days[targetDayName].tasks = clonedTasks;
            });

            saveData();
            safeClose($('#setupDialog'));
            alertInApp('Copied tasks to selected days.');
        };
      }

      // --- INITIALIZATION ---
      function start(){
        try {
          installGlobal();
          loadData();
        } catch(e){
          console.error('Initialization error:', e);
          document.body.innerHTML = '<h1>Error loading app. Please clear your cache and try again.</h1>';
        }
      }

      // Full implementations of functions omitted for the summary
      // These would be included in the final script
      const confettiCanvas = $('#confettiCanvas'), confettiCtx = confettiCanvas.getContext('2d');
      let confettiParticles = [], confettiActive = false;
      function resizeConfetti(){ confettiCanvas.width = window.innerWidth; confettiCanvas.height = window.innerHeight; }
      window.addEventListener('resize', resizeConfetti);
      resizeConfetti();
      
      // Placeholder for full confetti implementation
      function burstConfetti(x, y, count) {
        if (!confettiCtx) return;
        const colors = ['#FFD166','#06D6A0','#EF476F','#118AB2','#8338EC','#FFBE0B'];
        for (let i = 0; i < count; i++) {
            const angle = Math.random() * Math.PI * 2;
            const speed = 2 + Math.random() * 5;
            confettiParticles.push({
                x: x, y: y,
                vx: Math.cos(angle) * speed,
                vy: Math.sin(angle) * speed - 4 * Math.random(),
                size: 4 + Math.random() * 4,
                color: colors[Math.floor(Math.random() * colors.length)],
                life: 60 + Math.floor(Math.random() * 40)
            });
        }
        if (!confettiActive) {
            confettiActive = true;
            stepConfetti();
        }
      }

      function stepConfetti() {
          if (!confettiActive || !confettiCtx) return;
          confettiCtx.clearRect(0, 0, confettiCanvas.width, confettiCanvas.height);
          for (let i = confettiParticles.length - 1; i >= 0; i--) {
              const p = confettiParticles[i];
              p.vy += 0.15;
              p.x += p.vx;
              p.y += p.vy;
              p.life--;
              confettiCtx.fillStyle = p.color;
              confettiCtx.fillRect(p.x, p.y, p.size, p.size);
              if (p.life <= 0 || p.y > confettiCanvas.height + 10) {
                  confettiParticles.splice(i, 1);
              }
          }
          if (confettiParticles.length) {
              requestAnimationFrame(stepConfetti);
          } else {
              confettiCtx.clearRect(0, 0, confettiCanvas.width, confettiCanvas.height);
              confettiActive = false;
          }
      }

      celebrateAtElement = (el) => {
          try {
            const rect = el.getBoundingClientRect();
            burstConfetti(rect.left + rect.width / 2, rect.top + rect.height / 2, 120);
          } catch(e) {
            burstConfetti(window.innerWidth / 2, window.innerHeight / 3, 120);
          }
      };
      
      openViewer = (i) => {
          const t = getDay().tasks[i];
          if (!t) return;
          const dlg = $('#viewerDialog');
          $('#viewerImg').src = t.image || pickImg(t.name);
          $('#viewerImg').onerror = e => { e.target.onerror = null; e.target.src = 'assets/images/defaults/default.png'; };
          $('#viewerClose').onclick = () => safeClose(dlg);
          $('#viewerFinish').onclick = () => {
              if (!t.completed) {
                  t.completed = true;
                  try {
                      const a = $('#applause');
                      if (a) { a.currentTime = 0; a.play(); }
                  } catch (e) {}
                  burstConfetti(window.innerWidth / 2, window.innerHeight / 2, 140);
                  if (t.audio) { try { new Audio(t.audio).play(); } catch (e) {} }
                  saveData();
              }
              render();
              safeClose(dlg);
          };
          openDialog(dlg);
      };

      openEdit = (i) => {
          const t = getDay().tasks[i];
          if (!t) return;
          const dlg = $('#editDialog');
          $('#taskName').value = t.name || '';
          $('#taskTime').value = to24(t.time || '');
          $('#taskTimer').value = t.timer_minutes || '';
          const prev = $('#imagePreview');
          if (t.image) {
              prev.src = t.image;
              prev.style.display = '';
          } else {
              prev.style.display = 'none';
          }
          $('#cancelTaskBtn').onclick = () => safeClose(dlg);
          $('#saveTaskBtn').onclick = () => {
              const name = ($('#taskName').value || '').trim() || 'Task';
              let time = $('#taskTime').value;
              if (time) {
                  const parts = time.split(':');
                  let n = parseInt(parts[0], 10);
                  const ampm = n >= 12 ? 'PM' : 'AM';
                  let hh = ((n + 11) % 12) + 1;
                  time = String(hh < 10 ? ('0' + hh) : hh) + ':' + parts[1] + ' ' + ampm;
              }
              const timer = $('#taskTimer').value ? parseInt($('#taskTimer').value, 10) : null;
              
              t.name = name;
              t.time = time;
              t.timer_minutes = timer;

              const imgF = $('#taskImage').files[0];
              if (imgF) {
                  const r = new FileReader();
                  r.onload = () => {
                      t.image = r.result;
                      saveData();
                      render();
                      safeClose(dlg);
                  };
                  r.readAsDataURL(imgF);
              } else {
                  saveData();
                  render();
                  safeClose(dlg);
              }
          };
          openDialog(dlg);
      };

      to24 = (s) => {
          if (!s || !s.includes('M')) return s;
          const parts = s.split(' ');
          const hm = parts[0].split(':');
          let h = parseInt(hm[0], 10);
          const m = hm[1];
          const ap = parts[1];
          if (ap === 'PM' && h < 12) h += 12;
          if (ap === 'AM' && h === 12) h = 0;
          return (h < 10 ? '0' + h : String(h)) + ':' + m;
      };

      confirmInApp = (message) => new Promise(resolve => {
          const dlg = $('#confirmDialog');
          $('#confirmText').textContent = message || 'Confirm?';
          const okBtn = $('#confirmOk');
          const cancelBtn = $('#confirmCancel');
          const cleanup = (res) => {
              safeClose(dlg);
              okBtn.onclick = null;
              cancelBtn.onclick = null;
              resolve(res);
          };
          okBtn.onclick = () => cleanup(true);
          cancelBtn.onclick = () => cleanup(false);
          openDialog(dlg);
      });
      alertInApp = (message) => new Promise(resolve => {
          const dlg = $('#confirmDialog');
          $('#confirmText').textContent = message || '';
          const okBtn = $('#confirmOk');
          const cancelBtn = $('#confirmCancel');
          cancelBtn.style.display = 'none';
          okBtn.textContent = 'OK';
          okBtn.onclick = () => {
              cancelBtn.style.display = '';
              okBtn.textContent = 'Confirm';
              safeClose(dlg);
              okBtn.onclick = null;
              resolve();
          };
          openDialog(dlg);
      });

      if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', start);
      else start();
    })();
  </script>
</body>
</html>
